# S3( Simple Storage Service)

```properties
# ℹ️ 아마존 웹 서비스(AWS)가 제공하는 클라우드 스토리지 서비스이다.
#   - 파일, 데이터 및 다양한 유형의 미디어 등을 저장하고 관리하는 웹 기반 스토리지 시스템이다.
```

## S3 특징

- `객체` 스토리지 서비스이다.
  - 파일만 보관이 가능하다
    - 반대 개념 : Block Storage Service(EBS, EFS 등)
    - 어플리케이션 설치 불가능
- 글로벌 서비스이나 저장되는 데이터의 위치는 내가 지정한 지역(`region`)에 저장된다.

## 버킷

- S3의 저장 공간을 구분하는 단위이다.
  - 디렉토리 / 폴더와 같은 개념으로 보자
- 버킷의 이름은 전세계에서 **고유**의 값이다.
  - 지역(`region`)에 관계 없이 중복된 이름이 존재할 수 없다.

## S3 객체의 구성

```properties
# ℹ️ S3 자체가 해당 "객체"의 슽리지 서비스 이다.
```

- Owner : 소유자
- Key : 파일의 이름
- Value : 파일의 데이터
  - 해당 파일의 용량이 `0kb`여도 상관이 없다 (메타데이터 만으로도 의미가 있을 수 있기 때문)
- Version Id : 파일의 버전아이디
- Metadata : 파일의 정보를 담은 데이터
- ACL : 파일의 권한을 담은 데티터
- Torrents : 토렌트 공유를 위한 데이터

## S3 내구성

- 최소 3개의 가용영역에 데이터를 분산함(Standard의 경우)
- 높은 내구성과 높은 가용성을 보장한다.

## 보안 설정

- 모든 버킷은 새로 생성 시 기본적으로 Private(비공개) 이다.
  - 추가적인 설정을 통해 불특정 다수에게 공개가 가능하다
- 보안 설정은 객체 단위와 버켓 단위로 구성한다.
  - 👍(대부분 사용) Bucket Policy : 버킷 단위
  - 😒(요즘 잘 안씀) ALC(Access Control List) : 객체 단위
- MFA를 활용해 객체 삭제 방지 기능
- Versioning을 통해 파일 관리 가능
- 엑세스 로그 생성 및 전송이 가능
  - 다른 버킷 혹은 다른 계정으로 전송이 가능하다.

## 간단한 사용

- 시나리오
  - S3 내 버킷에 `index.php`파일을 저장
  - EC2 인스턴스를 올릴 때 httpd 설치 후 S3에서 해당 `index.php`파일을 받아와 가져옴
- 주의 사항

  - 인스턴스 생성 시 고급 세부 정보 -> `IAM(Identity and Access Management)` 설정을 통해 EC2가 S3에 접근 권한을 가져야한다.

    ![image](https://github.com/user-attachments/assets/a271ac53-3aa4-468d-9a18-9a3beceff8e1)

- 방법
  - S3 버킷명 생성
  - 생성된 버킷에 파일을 저장
    - 해당 버킷명 복사
  - 인스턴스 생성
    - 고급 세부 정보 내 사용자 데이터에 실행 시 진행 코드 설정

## S3 스토리지 클래스

```properties
# ℹ️ 다양한 스토리지 클래스가 존재하고 각각의 사용의 목적이 다르다.
#    ㄴ> 모든 사용모델에 맞춰 사용법을 알 필요가 없다.
#       =>  S3 Intelligent-Tiering을 사용하자
#           - 머신 러닝을 사용해 자동으로 사용 패턴을 확인하여 클래스를 이동해준다.
```

- 스탠다드
  - 가장 높은 가용성을 가지고 있다.
  - 최소 3개 이상의 가용영역에 분산 보관한다.
  - 최소 보관 기간 및 최소 용량 제한이 없다
- 스탠다드 IA(Infrequent Access)
  - 자주 사용되지 않는 데이터를 저렴한 가격에 보관
  - 최소 3개 이상의 가용영역에 보관
  - 최소 저장 용량 및 저장 기간이 존재
  - 사용 사례 : 자주 사용되지 않지만 중요한 파일을 저장하는 용도로 쓴다
- S3 One Zone-IA
  - 자주 사용되지 않고, 중요하지 않은 데이터
  - 단 한개의 가용 영역에만 보관
  - 최소 용량 및 저장 기간이 존재
  - 사용 사례 : 자주 사용하지 않으며 쉽게 복구가 가능한 파일 (썸네일)
- 아카이브 ( 자주 접근되지 않는 데이터를 장기간 보관하기 위한 스토리지 클래스 )
  - Glacier Instant Retrieval
  - Glacier Flexible Retrieval
  - Glacier Deep Archive

## IAM 정책 종류

- Identity-based policies(자격 증명 정책 기반)
  - 누가(Principal) 대상(Resource)에 작업(Action)을 조건(Condition)에 따라 허용여부(Effect)를 결정하는 것
  - 자격 증명(IAM 유저, 그룹, 역할)에 **부여하는 정책**
  - 해당 **자격 증명**이 **무엇을 할 수 있는지** 허용
- Resources-based policies(리소스 기반 정책)
  - 대상(Resource) 이 누구(Principal) 에 작업(Action)을 조건(Condition)에 따라 허용 여부(Effect)를 결정하는 것
  - 리소스(SC, SQS, CPC, KMS 등[기능])에 부여하는 정책
  - 해당 리소스에 누가 무엇을 할 수 있는가 허용 기능
    - Ex) SQS 대기열에 Lamda가 접근 가능

## S3 권한 관리

- 버킷 단위로 부여되는 `IAM의 Resources`기반 정책을 따른다
- 버킷 데이터에 "언제 어디서 누가 어떻게 무엇을" 할 지 정의가 가능
  - 리소스의 디렉토리 계층에 구조에 따라 권한 조절 가능
    - Ex) `arn:aws:s3::my~~/img/*` : /img 로 시작하는 모든 객체에 대하여
- 다른 계정에 엔티티에 대한 권한 설정 가눙
  - 해당 엔티티에 접근하고 싶다고 요청이 가능
- 익명 사용자에 대한 권한 설정 가능
  - 서비스 운영시 모든 사용자가 파일을 받아야 할 경우
- 기본적으로 모든 버킷은 Private로 지정 되어 있기에 아무나 접근이 불가능함.
- ### 주의 사항
  - AWS 콘솔에서는 S3의 디렉토리를 생성하고 확인이 가능 하지만 실제 데이터는 구조는 그렇지 않다.
    - S3 내부에는 계층 구조가 존재 하지 않는다.
      - 그냥 키 이름에 `/`로 구분자가 들어가 있는 형태이다.
    - 실제 구조
      - 버킷명 : `yooWorld`
      - 키 : `img/20240729/abc/foo.jpg`
  - 퍼블릭 액세스 차단 편집 (버킷 설정)을 풀어 주지않으면 권한을 변경해도 S3의 **오브젝트**에 접근 불가능
  - ### 버킷 관리 방법의 선틱 팁
    - Identity-based policies(자격 증명 정책 기반)
      - 같은 계정 내 `IAM` 엔티티의 S3 권한을 관리할 경우
      - S3 외 다른 AWS 서비스와 같이 권한 관리가 필요할 경우
    - Resources-based policies(리소스 기반 정책)
      - 익명의 사용자 혹은 다른 계정의 엔티티의 S3 이용 권한을 관리할때
      - S3만의 권한을 관리할 때

## S3 버전 관리

- 객체의 CRUD 모든 단계를 저장한다.
  - 삭제 시 실체 객체를 삭제하는 대신 삭제 마커를 추가 함
    - 해당 삭제 마커를 제거하면 **다시 다운로드 가능**하다.

    ![image](https://github.com/user-attachments/assets/d90f66e4-9730-41e7-ae18-afdc3bd8c7b5)
  
  - 파일 업데이트를 하면 이전 파일은 남아서 관리가 된다.
    - 상위 버전을 삭제하면 사용자가 요청 시 이전 버전을 자동으로 받게 된다.

   ![image](https://github.com/user-attachments/assets/a24f61f1-6c0c-4f3d-b63b-b22fa17112a8)
    
- 버킷 단위로 해당 **버전 관리** 기능을 활성화 해줘야한다.
  - ℹ️ 기본 설정 값 `비활성화` 상태
    - 모든 버전에 대하여 비용을 청구하기 때문이다.
  - 한번 버전 관리를 시작하면 비활성화 상태로 **변경 불가능**하다.
    - 해당 버킷을 삭제 후 재생성 해줘야 함
- 수명 주기 관리와 연동 가능

## S3 객체 잠금
- 고정된 시간 혹은 무기한으로 객체의 `삭제 / 수정` 방지
- 규정 준수 및 객체의 보호를 위해 사용한다.
- 사용을 위해 필수적으로 ℹ️ `버전 활성화` 필요
- 종류
  - 보관 모드 : 일정 기간 동안 수정 방지
    - 규정 준수 모드 : 어떠한 사람도 잠금 설정 변경이 불가능, 삭제 또한 불가능
    - 가버넌스 모드 : 특별한 권한없이 삭제 혹은 잠금 설정 변경이 불가능      
  - 법적 보존
    - `Hold`를 객체에 부여하고 `Hold`가 존재하는 한 객체 수정, 삭제 불가능


## S3 객체 암호화
- 암호화 구성
  - On Transit : SSL/TLS (`HTTPS`)
  - At Rest(Server Side)
    - SSE S3 : S3 자체 내에서 알아서 암호화 ( 직접 관여 X )

     ![image](https://github.com/user-attachments/assets/fab53264-2a79-4965-8d2c-3318e98541a5)
  
    - SSE KMS(서버측 암호화) : AWS KMS 서비스를 이용하여 암호화 ( KMS 인증 키 관여 가능 )
     - 해당 `KMS Key`를 사용해서 누가 사용할 수 있냐에 따 권한을 나눠서 사용이 가능하다.
     - S3 자체에서도 KMS 접근 권한이 있어야한다.
 
     ![image](https://github.com/user-attachments/assets/9515d013-97d3-402d-9869-354c94d797f2)
 
    - SSE C(고객 제공 키) : 클라이언트에서 제공하는 암호를 통해 암호화
      - 직접 우리가 Key를 관리해야한다.
     
      ![image](https://github.com/user-attachments/assets/b2285c1e-1a4e-45fa-9ac7-c7aeafec51bc)

